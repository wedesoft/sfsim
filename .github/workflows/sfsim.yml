name: SFsim CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  ubuntu-build-and-test:
    runs-on: ubuntu-latest
    steps:
    - name: Install APT packages
      run: |
        sudo apt -y update
        sudo apt -y install build-essential
        sudo apt -y install xvfb
        sudo apt -y install rlwrap
    - name: Install JoltPhysics
      run: |
        wget https://github.com/jrouwe/JoltPhysics/archive/refs/tags/v5.2.0.tar.gz -O JoltPhysics-5.2.0.tar.gz
        tar xzf JoltPhysics-5.2.0.tar.gz
        cd JoltPhysics-5.2.0/Build
        ./cmake_linux_clang_gcc.sh Release g++ -DCMAKE_POSITION_INDEPENDENT_CODE=ON -DDOUBLE_PRECISION=ON -DDEBUG_RENDERER_IN_DEBUG_AND_RELEASE=OFF -DPROFILER_IN_DEBUG_AND_RELEASE=OFF -DUSE_AVX2=OFF -DUSE_LZCNT=OFF -DUSE_TZCNT=OFF -DUSE_F16C=OFF -DUSE_FMADD=OFF
        cd Linux_Release
        make
        sudo make install
        cd ../..
    - uses: actions/checkout@v4
    - name: Install Java
      uses: actions/setup-java@v3
      with:
        distribution: 'oracle'
        java-version: '23'
    - name: Install Clojure
      uses: DeLaGuardo/setup-clojure@13.0
      with:
        cli: 1.12.0.1479
    - name: Build Jolt bindings
      run: make
    - name: Run tests
      run: xvfb-run clj -M:test
